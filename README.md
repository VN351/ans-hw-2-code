# Ansible Playbook для установки ClickHouse и Vector

## Содержание
- [Обзор](#обзор)
- [Особенности](#особенности)
- [Требования](#требования)
- [Инвентарь](#инвентарь)
- [Переменные](#переменные)
- [Использование](#использование)
- [Структура директорий](#структура-директорий)
- [Пример](#пример)


## Обзор

Этот Ansible playbook автоматически устанавливает и настраивает **ClickHouse** и **Vector** на указанных хостах. Он упрощает процесс развертывания, обеспечивая консистентную и эффективную установку обоих сервисов в вашей инфраструктуре.

- **ClickHouse:** Быстрая открытая система управления колонно-ориентированными базами данных.
- **Vector:** Высокопроизводительный конвейер данных для наблюдаемости.

## Особенности

- **Установка ClickHouse:**
  - Скачивает и устанавливает RPM-пакеты ClickHouse.
  - Создает необходимую базу данных ClickHouse.
  - Управляет сервисом ClickHouse.

- **Установка Vector:**
  - Скачивает и устанавливает RPM-пакеты Vector.
  - Применяет пользовательские конфигурации Vector через шаблоны.
  - Управляет сервисом Vector.

- **Модульный дизайн:**
  - Использует обработчики для управления состоянием сервисов.
  - Реализует обработку ошибок с помощью блоков rescue.
  - Поддерживает выборочное выполнение задач с использованием тегов.

## Требования

- **Ansible:** Версия 2.9 или выше.
- **Управляемые хосты:**
  - Операционная система: Совместима с дистрибутивами на основе RPM (например, CentOS, RHEL, Fedora).
  - Менеджер пакетов: Должен быть доступен yum.
- **Сетевой доступ:**
  - Возможность скачивания пакетов с внешних URL.
  - SSH-доступ к управляемым хостам.

## Инвентарь

Определите ваши управляемые хосты в инвентарном файле prod.yml, расположенном в папке templates, группируя их по категориям clickhouse и vector.

**Пример templates/prod.yml:**
```
clickhouse:
  hosts:
    clickhouse-01:
      ansible_connection: docker
vector:
  hosts:
    vector-01:
      ansible_connection: docker
```

## Переменные

Настройте playbook, задав следующие переменные. Их можно определить в group_vars, host_vars или передать через командную строку.

### Переменные ClickHouse

| Переменная              | Описание                                             | Пример                       |
|-------------------------|------------------------------------------------------|------------------------------|
| clickhouse_version    | Версия ClickHouse для установки.                     | 22.3.3.44                   |
| clickhouse_packages   | Список пакетов ClickHouse для скачивания и установки.| ["clickhouse-client", "clickhouse-server"] |

### Переменные Vector

| Переменная            | Описание                                            | Пример                                                             |
|-----------------------|-----------------------------------------------------|--------------------------------------------------------------------|
| vector_url          | URL для скачивания RPM-пакета Vector.               | https://packages.timber.io/vector/0.22.3/vector-0.22.3-1.x86_64.rpm   |
| vector_version      | Версия Vector для установки.                        | 0.22.3                                                           |
| vector_config_dir   | Директория, где находятся конфигурационные файлы Vector.| /etc/vector                                                   |


## Использование

1. **Клонируйте репозиторий:**
   
```
git clone https://github.com/VN351/ans-hw-2-code.git
cd ans-hw-2-code
```
2. **Настройте инвентарь:**
   Отредактируйте файл templates/prod.yml, добавив ваши хосты ClickHouse и Vector.


3. **Запустите Playbook:**
   - Для установки как ClickHouse, так и Vector:
    ```
    ansible-playbook -i templates/prod.yml site.yml
    ```  

## Структура директорий

ans-hw-2-code/
├── group_vars/
│   ├── clickhouse/
|   |   └── vars.yml          
│   └── vector
|       └── vars.yml
├── templates/
│   └── prod.yml
├── templates/
│   ├── vector.yml.j2
│   └── vector.service.j2
├── site.yml
└── README.md


- **site.yml:** Основной playbook, содержащий все задачи установки.
- **templates/prod.yml:** Определяет управляемые хосты, сгруппированные по сервисам.
- **group_vars/:** Директория для переменных, специфичных для групп.
- **templates/:** Содержит Jinja2 шаблоны для конфигурационных файлов.

**Запуск Playbook:**
    ```
    ansible-playbook -i templates/prod.yml site.yml
    ```
